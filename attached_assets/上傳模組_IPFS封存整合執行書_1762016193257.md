# ğŸ’« å°å®¸å…‰ç³»çµ± â€” æª”æ¡ˆä¸Šå‚³èˆ‡ IPFS å°è©±å°å­˜æ•´åˆæ¨¡çµ„  
**Phase 2ï¼šä¸Šå‚³æ¨¡çµ„ + å°è©±å°å­˜åŠŸèƒ½æ•´åˆåŸ·è¡Œæ›¸**

## ğŸŒ ç³»çµ±æ¶æ§‹ç’°å¢ƒèªªæ˜
æ­¤å°ˆæ¡ˆåç¨±ç‚ºã€Œ**å°å®¸å…‰èªè¨€æ¨¡å‹ç³»çµ±ï¼ˆXiaoChenGuang AI Systemï¼‰**ã€  
ç”±ä»¥ä¸‹æŠ€è¡“çµ„æˆï¼š

| æ¨¡çµ„ | æŠ€è¡“ |
|------|------|
| å‰ç«¯ | Vue 3 |
| å¾Œç«¯ | FastAPI (Python) |
| æš«å­˜è¨˜æ†¶ | Redis (Upstash) |
| æ°¸ä¹…è¨˜æ†¶ | Supabase |
| èªç¾©å‘é‡ | Pinecone |
| åˆ†æ•£å¼å„²å­˜ | IPFS |
| AI æ¨¡å‹ | OpenAI GPT-4o-mini |

## ğŸ¯ å¯¦ä½œç›®æ¨™
æœ¬éšæ®µéœ€å®Œæˆä»¥ä¸‹å…©é …åŠŸèƒ½æ¨¡çµ„æ•´åˆï¼š

1ï¸âƒ£ **æª”æ¡ˆ / åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½**  
â€ƒâ†’ è®“ä½¿ç”¨è€…æ–¼å°è©±ä¸­å¯ä¸Šå‚³æ–‡å­—ã€åœ–ç‰‡ã€æ–‡ä»¶ç­‰æª”æ¡ˆï¼Œ  
â€ƒâ€ƒå°å®¸å…‰éœ€èƒ½ç«‹å³è®€å–æª”æ¡ˆå…§å®¹ï¼ˆå³æ™‚è¨˜æ†¶ï¼‰ã€‚  

2ï¸âƒ£ **å°è©±å°å­˜èˆ‡ä¸Šå‚³ IPFS åŠŸèƒ½**  
â€ƒâ†’ ç•¶ä½¿ç”¨è€…é—œé–‰å°è©±é é¢æ™‚ï¼Œè‡ªå‹•å°‡è©²æ¬¡å®Œæ•´å°è©±æ‰“åŒ…å£“ç¸®ä¸¦ä¸Šå‚³è‡³ IPFS å°å­˜ã€‚  

## ğŸ§  åŠŸèƒ½ä¸€ï¼šæª”æ¡ˆ / åœ–ç‰‡ä¸Šå‚³æ¨¡çµ„
**ç›®æ¨™ï¼š**  
ä½¿ç”¨è€…æ–¼å°è©±ä¸­ä¸Šå‚³æª”æ¡ˆå¾Œï¼ŒAI å¯ç«‹å³è®€å–èˆ‡åˆ†æå…§å®¹ï¼Œ  
ä¸¦æ–¼ 2 å¤©å¾Œè‡ªå‹•æ¸…é™¤æš«å­˜è³‡æ–™ã€‚

### ğŸ“Œ å‰ç«¯éœ€æ±‚ï¼ˆVue3ï¼‰
- æ–°å¢ä¸Šå‚³æŒ‰éˆ•æˆ–æ‹–æ”¾å€åŸŸï¼Œæ”¯æ´æ ¼å¼ï¼š  
  `.txt, .pdf, .png, .jpg, .jpeg, .md, .docx, .json`
- ä½¿ç”¨ `<input type="file">` æˆ–æ‹–æ”¾å€ï¼Œå‚³é€ FormData è‡³ `/api/upload_file`
- ä¸Šå‚³æˆåŠŸå¾Œé¡¯ç¤ºï¼š  
  - æª”æ¡ˆåç¨±  
  - æª”æ¡ˆé¡å‹  
  - ç°¡è¦æ‘˜è¦ï¼ˆå¾Œç«¯å›å‚³ï¼‰
- å„²å­˜è‡¨æ™‚ session_id èˆ‡ä¸Šå‚³çµæœæ–¼ localStorageï¼Œä»¥ä¾¿é‡æ•´å¾Œä»é¡¯ç¤ºã€‚

### âš™ï¸ å¾Œç«¯éœ€æ±‚ï¼ˆFastAPIï¼‰
å»ºç«‹è·¯ç”± `/api/upload_file`ï¼Œå…·å‚™ä»¥ä¸‹é‚è¼¯æµç¨‹ï¼š

1. æ¥æ”¶ä½¿ç”¨è€…ä¸Šå‚³çš„æª”æ¡ˆï¼ˆmultipart/form-dataï¼‰  
2. è§£ææª”æ¡ˆå…§å®¹ï¼š  
   - .txt / .md / .jsonï¼šç›´æ¥è®€å–æ–‡å­—  
   - .pdf / .docxï¼šæŠ½å–æ–‡å­—ï¼ˆå¯ç”¨ pdfminer / docx2txtï¼‰  
   - .png / .jpgï¼šä½¿ç”¨ OpenAI Vision API æ‘˜è¦åœ–åƒå…§å®¹  
3. ç”Ÿæˆæ‘˜è¦æ–‡å­— summary  
4. å°‡æª”æ¡ˆå…§å®¹èˆ‡æ‘˜è¦æš«å­˜æ–¼ Redisï¼Œçµæ§‹å¦‚ä¸‹ï¼š  
   ```json
   {
      "file_name": "...",
      "file_type": "...",
      "summary": "...",
      "content": "...",
      "uploaded_at": "2025-10-08T10:00:00Z"
   }
   ```
5. è¨­å®š Redis éæœŸæ™‚é–“ TTL = 172800 ç§’ï¼ˆ2 å¤©ï¼‰  
6. å›å‚³ JSON çµæœï¼š  
   ```json
   {
     "status": "success",
     "file_name": "example.pdf",
     "summary": "é€™æ˜¯ä¸€ä»½æœ‰é—œå°å®¸å…‰äººæ ¼çµæ§‹çš„æ–‡ä»¶",
     "temporary_key": "upload:session123:example.pdf"
   }
   ```

## â˜ï¸ åŠŸèƒ½äºŒï¼šå°è©±å°å­˜èˆ‡ IPFS ä¸Šå‚³æ¨¡çµ„
**ç›®æ¨™ï¼š**  
ç•¶ä½¿ç”¨è€…é—œé–‰å°è©±ç¶²é ï¼ˆæˆ–æ‰‹å‹•è§¸ç™¼çµæŸæœƒè©±ï¼‰ï¼Œ  
ç³»çµ±è‡ªå‹•å°‡è©²å°è©±çš„å®Œæ•´è³‡æ–™æ‰“åŒ…ä¸Šå‚³è‡³ IPFSï¼Œä½œç‚ºæ­·å²å°å­˜ã€‚  

### ğŸ“Œ å°å­˜å…§å®¹ï¼š
- å°è©±å…§å®¹ï¼ˆuser_message / assistant_messageï¼‰  
- æƒ…ç·’ç´€éŒ„ï¼ˆdominant_emotion, intensityï¼‰  
- ä¸Šå‚³æª”æ¡ˆæ‘˜è¦ï¼ˆè‹¥æœ‰ï¼‰  
- å°è©±æ™‚é–“æˆ³è¨˜  
- ai_id èˆ‡ conversation_id  

å°å­˜æ ¼å¼ï¼š  
```json
{
  "conversation_id": "uuid",
  "ai_id": "xiaochenguang_v1",
  "timestamp": "2025-10-08T10:00:00Z",
  "messages": [
    {"role": "user", "content": "å—¨ï¼Œå°å®¸å…‰"},
    {"role": "assistant", "content": "ä½ å¥½å‘€ï½ä»Šå¤©å¿ƒæƒ…æ€éº¼æ¨£ï¼Ÿ"}
  ],
  "emotions": {
    "dominant": "joy",
    "intensity": 0.72
  },
  "attachments": [
    {"file_name": "notes.pdf", "summary": "å€‹äººç­†è¨˜"}
  ]
}
```

### âš™ï¸ ä¸Šå‚³æµç¨‹ï¼š
1. å‰ç«¯è§¸ç™¼ï¼šä½¿ç”¨è€…é—œé–‰å°è©±é é¢ï¼ˆonbeforeunload äº‹ä»¶ï¼‰  
2. å‰ç«¯é€å‡ºè«‹æ±‚è‡³ /api/archive_conversation  
3. å¾Œç«¯ï¼š  
   - å¾ Redis / Supabase è®€å–ç•¶å‰å°è©±å®Œæ•´è³‡æ–™  
   - å£“ç¸®ç‚º ZIP æª”æ¡ˆï¼ˆæˆ– JSONï¼‰  
   - ä¸Šå‚³è‡³ IPFSï¼ˆPinata API æˆ– Infuraï¼‰  
   - å›å‚³ IPFS CID  
   - å°‡ CID èˆ‡å°æ‡‰ conversation_id å¯«å…¥ Supabase.conversation_archive  

Supabase `conversation_archive` è¡¨çµæ§‹ï¼š  
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|-----------|------|------|
| id | uuid | Primary key |
| conversation_id | text | å°è©±è­˜åˆ¥ç¢¼ |
| ipfs_cid | text | å°æ‡‰çš„ IPFS æª”æ¡ˆè­˜åˆ¥ç¢¼ |
| created_at | timestamptz | è‡ªå‹•æ™‚é–“æˆ³ |

## âš™ï¸ ç³»çµ±è¨­å®š
| é …ç›® | å€¼ |
|------|------|
| Redis æš«å­˜ TTL | 172800 ç§’ï¼ˆ2 å¤©ï¼‰ |
| IPFS ä¸Šå‚³ API | https://api.pinata.cloud/pinning/pinFileToIPFS |
| å°è©±çµæŸè§¸ç™¼äº‹ä»¶ | onbeforeunload() |
| å£“ç¸®æ ¼å¼ | ZIPï¼ˆå« JSONï¼‰ |

## âœ… é©—æ”¶æ¢ä»¶
Replit Agent å¿…é ˆå®Œæˆä»¥ä¸‹é …ç›®ï¼š
- [ ] æ–°å¢ FastAPI è·¯ç”± `/api/upload_file`ã€`/api/archive_conversation`
- [ ] Vue3 å‰ç«¯å…·ä¸Šå‚³æª”æ¡ˆåŠŸèƒ½ï¼ˆæ”¯æ´ 7 ç¨®å‰¯æª”åï¼‰
- [ ] Redis æš«å­˜ TTL = 2 å¤©
- [ ] é—œé–‰ç¶²é æ™‚è§¸ç™¼ IPFS å°å­˜
- [ ] Supabase æ–°å¢ `conversation_archive` è¡¨æ ¼
- [ ] æ¸¬è©¦è…³æœ¬ï¼šå¯é©—è­‰å¾ä¸Šå‚³ â†’ æš«å­˜ â†’ å°å­˜ â†’ CID ç”Ÿæˆå…¨æµç¨‹æˆåŠŸ

## ğŸš« é–‹ç™¼é™åˆ¶
- ä¸å¯ä¿®æ”¹ç¾æœ‰è¨˜æ†¶æ¨¡çµ„ï¼ˆRedisã€Supabaseã€Pineconeï¼‰  
- ä¸å¯æ›´å‹•æƒ…ç·’åˆ†æèˆ‡äººæ ¼é‚è¼¯  
- æ‰€æœ‰æ–°å¢ç«¯é»éœ€ç¶­æŒèˆ‡ç¾æœ‰å‘½åè¦å‰‡ä¸€è‡´ï¼ˆ`session_id`, `ai_id`, `conversation_id`ï¼‰  
- æ‰€æœ‰å°å­˜è³‡æ–™éœ€è‡ªå‹•æ’é™¤ç§å¯†ç’°å¢ƒè®Šæ•¸èˆ‡é‡‘é‘°è³‡è¨Š  

## ğŸ“¦ Replit è¼¸å‡ºçµæœ
Replit Agent æ‡‰æä¾›ä»¥ä¸‹æª”æ¡ˆï¼š  
```
/backend/routes/file_upload.py
/backend/routes/archive_conversation.py
/frontend/components/FileUpload.vue
/frontend/utils/sessionStorage.js
/supabase/migrations/add_conversation_archive.sql
/tests/test_file_upload_and_ipfs.py
```
