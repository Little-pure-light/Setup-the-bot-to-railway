# 💫 小宸光系統 — 檔案上傳與 IPFS 對話封存整合模組  
**Phase 2：上傳模組 + 對話封存功能整合執行書**

## 🌐 系統架構環境說明
此專案名稱為「**小宸光語言模型系統（XiaoChenGuang AI System）**」  
由以下技術組成：

| 模組 | 技術 |
|------|------|
| 前端 | Vue 3 |
| 後端 | FastAPI (Python) |
| 暫存記憶 | Redis (Upstash) |
| 永久記憶 | Supabase |
| 語義向量 | Pinecone |
| 分散式儲存 | IPFS |
| AI 模型 | OpenAI GPT-4o-mini |

## 🎯 實作目標
本階段需完成以下兩項功能模組整合：

1️⃣ **檔案 / 圖片上傳功能**  
 → 讓使用者於對話中可上傳文字、圖片、文件等檔案，  
  小宸光需能立即讀取檔案內容（即時記憶）。  

2️⃣ **對話封存與上傳 IPFS 功能**  
 → 當使用者關閉對話頁面時，自動將該次完整對話打包壓縮並上傳至 IPFS 封存。  

## 🧠 功能一：檔案 / 圖片上傳模組
**目標：**  
使用者於對話中上傳檔案後，AI 可立即讀取與分析內容，  
並於 2 天後自動清除暫存資料。

### 📌 前端需求（Vue3）
- 新增上傳按鈕或拖放區域，支援格式：  
  `.txt, .pdf, .png, .jpg, .jpeg, .md, .docx, .json`
- 使用 `<input type="file">` 或拖放區，傳送 FormData 至 `/api/upload_file`
- 上傳成功後顯示：  
  - 檔案名稱  
  - 檔案類型  
  - 簡要摘要（後端回傳）
- 儲存臨時 session_id 與上傳結果於 localStorage，以便重整後仍顯示。

### ⚙️ 後端需求（FastAPI）
建立路由 `/api/upload_file`，具備以下邏輯流程：

1. 接收使用者上傳的檔案（multipart/form-data）  
2. 解析檔案內容：  
   - .txt / .md / .json：直接讀取文字  
   - .pdf / .docx：抽取文字（可用 pdfminer / docx2txt）  
   - .png / .jpg：使用 OpenAI Vision API 摘要圖像內容  
3. 生成摘要文字 summary  
4. 將檔案內容與摘要暫存於 Redis，結構如下：  
   ```json
   {
      "file_name": "...",
      "file_type": "...",
      "summary": "...",
      "content": "...",
      "uploaded_at": "2025-10-08T10:00:00Z"
   }
   ```
5. 設定 Redis 過期時間 TTL = 172800 秒（2 天）  
6. 回傳 JSON 結果：  
   ```json
   {
     "status": "success",
     "file_name": "example.pdf",
     "summary": "這是一份有關小宸光人格結構的文件",
     "temporary_key": "upload:session123:example.pdf"
   }
   ```

## ☁️ 功能二：對話封存與 IPFS 上傳模組
**目標：**  
當使用者關閉對話網頁（或手動觸發結束會話），  
系統自動將該對話的完整資料打包上傳至 IPFS，作為歷史封存。  

### 📌 封存內容：
- 對話內容（user_message / assistant_message）  
- 情緒紀錄（dominant_emotion, intensity）  
- 上傳檔案摘要（若有）  
- 對話時間戳記  
- ai_id 與 conversation_id  

封存格式：  
```json
{
  "conversation_id": "uuid",
  "ai_id": "xiaochenguang_v1",
  "timestamp": "2025-10-08T10:00:00Z",
  "messages": [
    {"role": "user", "content": "嗨，小宸光"},
    {"role": "assistant", "content": "你好呀～今天心情怎麼樣？"}
  ],
  "emotions": {
    "dominant": "joy",
    "intensity": 0.72
  },
  "attachments": [
    {"file_name": "notes.pdf", "summary": "個人筆記"}
  ]
}
```

### ⚙️ 上傳流程：
1. 前端觸發：使用者關閉對話頁面（onbeforeunload 事件）  
2. 前端送出請求至 /api/archive_conversation  
3. 後端：  
   - 從 Redis / Supabase 讀取當前對話完整資料  
   - 壓縮為 ZIP 檔案（或 JSON）  
   - 上傳至 IPFS（Pinata API 或 Infura）  
   - 回傳 IPFS CID  
   - 將 CID 與對應 conversation_id 寫入 Supabase.conversation_archive  

Supabase `conversation_archive` 表結構：  
| 欄位名稱 | 類型 | 說明 |
|-----------|------|------|
| id | uuid | Primary key |
| conversation_id | text | 對話識別碼 |
| ipfs_cid | text | 對應的 IPFS 檔案識別碼 |
| created_at | timestamptz | 自動時間戳 |

## ⚙️ 系統設定
| 項目 | 值 |
|------|------|
| Redis 暫存 TTL | 172800 秒（2 天） |
| IPFS 上傳 API | https://api.pinata.cloud/pinning/pinFileToIPFS |
| 對話結束觸發事件 | onbeforeunload() |
| 壓縮格式 | ZIP（含 JSON） |

## ✅ 驗收條件
Replit Agent 必須完成以下項目：
- [ ] 新增 FastAPI 路由 `/api/upload_file`、`/api/archive_conversation`
- [ ] Vue3 前端具上傳檔案功能（支援 7 種副檔名）
- [ ] Redis 暫存 TTL = 2 天
- [ ] 關閉網頁時觸發 IPFS 封存
- [ ] Supabase 新增 `conversation_archive` 表格
- [ ] 測試腳本：可驗證從上傳 → 暫存 → 封存 → CID 生成全流程成功

## 🚫 開發限制
- 不可修改現有記憶模組（Redis、Supabase、Pinecone）  
- 不可更動情緒分析與人格邏輯  
- 所有新增端點需維持與現有命名規則一致（`session_id`, `ai_id`, `conversation_id`）  
- 所有封存資料需自動排除私密環境變數與金鑰資訊  

## 📦 Replit 輸出結果
Replit Agent 應提供以下檔案：  
```
/backend/routes/file_upload.py
/backend/routes/archive_conversation.py
/frontend/components/FileUpload.vue
/frontend/utils/sessionStorage.js
/supabase/migrations/add_conversation_archive.sql
/tests/test_file_upload_and_ipfs.py
```
