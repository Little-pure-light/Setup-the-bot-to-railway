ã€Šè¨˜æ†¶æ¨¡çµ„ï¼ˆMemory Moduleï¼‰å·¥ç¨‹èªè¨€è¨­è¨ˆæŒ‡å—æ›¸ã€‹
Memory System Engineering Prompt Design Document

ğŸ“˜ æª”æ¡ˆåç¨±å»ºè­°
memory_module_design_prompt.md

ğŸ¯ è¨­è¨ˆç›®æ¨™
æœ¬è¨­è¨ˆæŒ‡å—ç”¨æ–¼æŒ‡å° AI Agent ä»¥å·¥ç¨‹èªè¨€è¨­è¨ˆå‡ºè¨˜æ†¶æ¨¡çµ„ï¼ˆMemory Moduleï¼‰ã€‚
 è©²æ¨¡çµ„æ˜¯æ•´å€‹å°å®¸å…‰ AI ç³»çµ±çš„ä¸­æ¨ç¥ç¶“è³‡æ–™å±¤ï¼Œ
 è² è²¬å°‡æ‰€æœ‰å°è©±ã€åæ€ã€å¾®èª¿è¼¸å‡ºä»¥ã€Œæ•¸å­—åŒ–ï¼ˆtoken-basedï¼‰ã€å½¢å¼ä¿å­˜ä¸¦å›æº¯ã€‚
åŠŸèƒ½è¦é»
å°è©±ç´€éŒ„æ•¸å­—åŒ–ï¼ˆtoken encodingï¼‰


è¨˜æ†¶åˆ†é¡å„²å­˜ï¼ˆçŸ­æœŸï¼šRedisã€é•·æœŸï¼šSupabaseï¼‰


æ”¯æ´åæ€ç´€éŒ„ã€è‡ªå‹•å›æº¯


æ”¯æ´æ—¥èªŒç´¢å¼•ï¼ˆCID - IPFSï¼‰


æä¾›çµ±ä¸€ä»‹é¢ä¾›å…¶ä»–æ¨¡çµ„èª¿ç”¨ï¼ˆæ™ºæ…§æ¨¡çµ„ã€è¡Œç‚ºæ¨¡çµ„ã€å¾®èª¿æ¨¡çµ„ç­‰ï¼‰



ğŸ§© ç³»çµ±å®šä½
è¨˜æ†¶æ¨¡çµ„æ˜¯äº”å¤§æ¨¡çµ„çš„ã€Œæ ¸å¿ƒæ¨ç´ã€ï¼Œæ‰€æœ‰æ¨¡çµ„éƒ½å¿…é ˆé€éå®ƒå­˜å–è³‡æ–™ã€‚
æ¨¡çµ„
èˆ‡è¨˜æ†¶æ¨¡çµ„é—œä¿‚
æ™ºæ…§æ¨¡çµ„
å°‡ AI çš„è¼¸å…¥èˆ‡å›è¦†äº¤ç”±è¨˜æ†¶æ¨¡çµ„è½‰ token ä¸¦å„²å­˜
åæ€æ¨¡çµ„
å°‡åæ€çµæœå­˜å…¥è¨˜æ†¶æ¨¡çµ„ï¼ˆåŒæ™‚å»ºç«‹åæ€ç´¢å¼•ï¼‰
å¾®èª¿æ¨¡çµ„
ä»¥è¨˜æ†¶æ¨¡çµ„çš„ token è³‡æ–™ä½œç‚ºè¨“ç·´è¼¸å…¥
è¡Œç‚ºèª¿ç¯€æ¨¡çµ„
æ ¹æ“šè¨˜æ†¶è¶¨å‹¢å›è®€æ•¸æ“šèª¿æ•´äººæ ¼å‘é‡
çŸ¥è­˜åº«æ¨¡çµ„
èˆ‡è¨˜æ†¶æ¨¡çµ„å…±äº«å¯å…¬é–‹çš„çŸ¥è­˜å‹è³‡æ–™


ğŸ§± ç›®éŒ„èˆ‡æª”æ¡ˆçµæ§‹å»ºè­°
backend/
â”œâ”€â”€ memory_module/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ memory_core.py           # ä¸»é‚è¼¯æ ¸å¿ƒ
â”‚   â”œâ”€â”€ redis_interface.py       # Redis çŸ­æœŸè¨˜æ†¶æ¥å£
â”‚   â”œâ”€â”€ supabase_interface.py    # Supabase é•·æœŸè¨˜æ†¶æ¥å£
â”‚   â”œâ”€â”€ tokenizer_engine.py      # Token åŒ–è™•ç†æ ¸å¿ƒ
â”‚   â”œâ”€â”€ reflection_indexer.py    # åæ€ç´¢å¼•èˆ‡ IPFS è™•ç†
â”‚   â””â”€â”€ memory_config.json       # æ¨¡çµ„è¨­å®šï¼ˆAPI keyã€å„²å­˜çµæ§‹ï¼‰


âš™ï¸ åŠŸèƒ½è¨­è¨ˆåˆ†å±¤
1ï¸âƒ£ Tokenization Layer - tokenizer_engine.py
ä½¿ç”¨ tiktoken æˆ– HuggingFace tokenizerã€‚


å°‡æ–‡å­—è³‡æ–™ï¼ˆä½¿ç”¨è€…è¨Šæ¯ã€AI å›è¦†ã€åæ€ï¼‰è½‰æ›ç‚ºæ•¸å­—åŒ– tokenã€‚


è¼¸å‡ºæ ¼å¼ï¼š

 {
  "text": "ä½ å¥½ï¼Œå°å®¸å…‰ï¼",
  "tokens": [2103, 188, 420],
  "encoding": "cl100k_base",
  "context_id": "conv_20251019_001",
  "type": "chat_message"
}


2ï¸âƒ£ Short-term Memory Layer - redis_interface.py
è§’è‰²ï¼šæš«å­˜æœ€è¿‘å°è©±ã€åæ€è³‡æ–™ï¼ˆç´„è¿‘ 100 æ¢ï¼‰


Redis éµè¨­è¨ˆï¼š

 memory:conversation:{conversation_id}
memory:reflection:{reflection_id}


ä½¿ç”¨ TTLï¼ˆTime-To-Liveï¼‰æ©Ÿåˆ¶ï¼Œè‡ªå‹•éæœŸè½‰å­˜å…¥é•·æœŸè¨˜æ†¶ã€‚


3ï¸âƒ£ Long-term Memory Layer - supabase_interface.py
æ°¸ä¹…å„²å­˜æ‰€æœ‰ Token åŒ–è³‡æ–™èˆ‡åæ€ç´€éŒ„ã€‚


è¡¨çµæ§‹ï¼ˆå»ºè­°åƒè€ƒæ—¢æœ‰ Supabase schemaï¼Œä¸æ–°å¢ç„¡é—œè¡¨ï¼‰ï¼š


æ¬„ä½åç¨±
é¡å‹
èªªæ˜
id
uuid
ä¸»éµ
user_id
text
ç”¨æˆ¶ ID
context_id
text
å°è©± ID
tokens
jsonb
token æ•¸æ“š
text_cache
text
åŸå§‹æ–‡å­—ï¼ˆé¸å¡«ï¼‰
module
text
ä¾†æºæ¨¡çµ„ï¼ˆchat / reflection / finetuneï¼‰
cid
text
IPFS ç´¢å¼•ï¼ˆå¦‚æœ‰ï¼‰
created_at
timestamp
å»ºç«‹æ™‚é–“


æ‰€æœ‰å¯«å…¥å‹•ä½œç”± memory_core.py çš„ commit_to_longterm() çµ±ä¸€è™•ç†ã€‚


4ï¸âƒ£ Reflection & CID Indexer Layer - reflection_indexer.py
ç•¶åæ€æ¨¡çµ„ç”¢ç”Ÿæ–°çš„ã€Œåæ€å…§å®¹ã€æ™‚ï¼š


å„²å­˜åæ€å…§å®¹è‡³ Supabaseï¼›


å°‡æ–‡å­—ä¸Šå‚³è‡³ IPFSï¼Œç²å– CIDï¼›


å°‡ CID æ›´æ–°å› memory_reflections è¡¨ï¼›


è¿”å›çµ¦æ™ºæ…§æ¨¡çµ„ä»¥æ›´æ–°ç•¶å‰äººæ ¼è¡Œç‚ºæ¬Šé‡ã€‚


5ï¸âƒ£ Memory Control Layer - memory_core.py
æ‰€æœ‰è¨˜æ†¶æ“ä½œçš„ä¸»æ§å±¤ã€‚


æä¾›çµ±ä¸€ API çµ¦å…¶ä»–æ¨¡çµ„ä½¿ç”¨ï¼š


class MemoryCore:
    def __init__(self, redis_client, supabase_client, tokenizer):
        self.redis = redis_client
        self.supabase = supabase_client
        self.tokenizer = tokenizer

    def save_chat(self, user_message, assistant_message, context_id, user_id):
        """å„²å­˜å°è©±å…§å®¹ï¼ˆçŸ­æœŸ + é•·æœŸï¼‰"""
        data = self.tokenizer.encode(user_message, assistant_message)
        self.redis.store_short_term(data)
        self.supabase.commit_to_longterm(data)

    def save_reflection(self, reflection_text, context_id):
        """å„²å­˜åæ€ç´€éŒ„"""
        token_data = self.tokenizer.encode(reflection_text)
        cid = self.upload_to_ipfs(reflection_text)
        self.supabase.commit_to_longterm({**token_data, "cid": cid})

    def upload_to_ipfs(self, content):
        """ä¸Šå‚³è‡³ IPFS ä¸¦å›å‚³ CID"""
        pass

    def get_memory_context(self, context_id):
        """è®€å–æŒ‡å®šå°è©±çš„å®Œæ•´è¨˜æ†¶è³‡æ–™"""
        pass


ğŸ”„ æ¨¡çµ„é€šä¿¡å”å®šï¼ˆçµ¦å…¶ä»–æ¨¡çµ„ç”¨ï¼‰
çµ±ä¸€é€é memory_core.py èª¿ç”¨ï¼Œç¦æ­¢æ¨¡çµ„ç›´æ¥å‘¼å« Redis æˆ– Supabaseã€‚
åŠŸèƒ½
èª¿ç”¨æ–¹å¼
å„²å­˜å°è©±
memory.save_chat(user_message, ai_message, context_id, user_id)
å„²å­˜åæ€
memory.save_reflection(reflection_text, context_id)
è®€å–å°è©±æ­·å²
memory.get_memory_context(context_id)
æŸ¥è©¢ CID ç´¢å¼•
memory.get_reflection_cid(context_id)


ğŸ§  Token å„²å­˜ç­–ç•¥
çŸ­æœŸè¨˜æ†¶ï¼ˆRedisï¼‰ï¼š


ç”¨æ–¼å¿«é€Ÿå›æ‡‰ã€ä¸Šä¸‹æ–‡å»¶çºŒï¼›


è‡ªå‹•éæœŸå¾Œå¯«å…¥é•·æœŸè¨˜æ†¶ï¼›


æ ¼å¼ï¼š

 {
  "user": [4321, 95, 102],
  "assistant": [1843, 900, 22],
  "timestamp": "2025-10-19T15:42:10"
}


é•·æœŸè¨˜æ†¶ï¼ˆSupabaseï¼‰ï¼š


åŒ…å«æ‰€æœ‰æ•¸æ“šï¼ˆåæ€ã€å¾®èª¿è¨“ç·´çµæœã€æ—¥è¨˜ç´¢å¼•ï¼‰ï¼›


èˆ‡ IPFS è³‡æ–™éˆçµä¿æŒä¸€è‡´ã€‚



ğŸª è‡ªæˆ‘åæ€é€£å‹•é‚è¼¯
æ™ºæ…§æ¨¡çµ„ç”Ÿæˆå›è¦†å¾Œï¼Œè§¸ç™¼åæ€æ¨¡çµ„ï¼›


åæ€æ¨¡çµ„ç”¢ç”Ÿçµæœå¾Œå‘¼å«ï¼š

 memory.save_reflection(reflection_text, context_id)


memory_moduleï¼š


å°‡åæ€å…§å®¹è½‰ Tokenï¼›


ä¸Šå‚³æ–‡å­—è‡³ IPFSï¼›


å›å‚³ CIDï¼›


å„²å­˜åˆ° Supabaseï¼›


åæ€æ¨¡çµ„æ”¶åˆ° CID å¾Œï¼Œå°‡æ­¤çµæœå›é¥‹çµ¦æ™ºæ…§æ¨¡çµ„ï¼›


æ™ºæ…§æ¨¡çµ„æ›´æ–°äººæ ¼åå¥½æˆ–å­¸ç¿’ç­–ç•¥ã€‚



ğŸ§© æ¨¡çµ„ä»‹é¢è¨»å†Šæ ¼å¼ï¼ˆä¾› core_controller è¼‰å…¥ï¼‰
{
  "name": "MemoryModule",
  "path": "backend/memory_module",
  "main": "memory_core.py",
  "dependencies": ["redis", "supabase", "ipfs", "tiktoken"],
  "type": "core",
  "description": "ç®¡ç†æ‰€æœ‰AIè¨˜æ†¶çš„æ•¸å­—åŒ–ã€å„²å­˜èˆ‡å›æº¯ã€‚",
  "load_priority": 1
}


ğŸ” å®‰å…¨èˆ‡æ•ˆèƒ½å»ºè­°
é¢å‘
å»ºè­°
æ•ˆèƒ½
Redis å¯«å…¥éåŒæ­¥è™•ç†ï¼Œé¿å…é˜»å¡ä¸»ç·šç¨‹
å®‰å…¨
æ‰€æœ‰è³‡æ–™ä¸Šå‚³ IPFS å‰å…ˆåš SHA256 é›œæ¹Šç°½å
éš±ç§
text_cache æ¬„ä½è¨­ç½®åŠ å¯†ï¼ˆå¦‚ AESï¼‰
å¯æ“´å±•æ€§
Supabase è³‡æ–™è¡¨æ¡ç”¨ jsonb æ¬„ä½å­˜ token é™£åˆ—ä»¥æ”¯æ´å¤šèªè¨€æ¨¡å‹


âœ… è¼¸å‡ºé©—æ”¶æ¢ä»¶
AI Agent åœ¨ç”Ÿæˆè©²æ¨¡çµ„ä»£ç¢¼æ™‚ï¼Œéœ€æ»¿è¶³ä»¥ä¸‹ï¼š
æ‰€æœ‰ä¸»è¦å‡½å¼å‡å…·å‚™ docstringï¼›


æ‰€æœ‰æ¨¡çµ„å¯ç¨ç«‹é‹è¡Œå–®å…ƒæ¸¬è©¦ï¼›


ä¸æ–°å¢è³‡æ–™è¡¨ï¼›


æ•´åˆå¾Œå‰ç«¯ä»å¯æ­£å¸¸å‘¼å«å°è©± APIï¼›


æ‰€æœ‰æ–‡å­—è³‡æ–™å‡ç¶“é token æ•¸å­—åŒ–å„²å­˜ï¼›


å¯æŸ¥è©¢ token å°æ‡‰åŸå§‹æ–‡å­—ï¼ˆä¾›èª¿è©¦ç”¨ï¼‰ã€‚



ğŸ’¬ å¾ŒçºŒå»ºè­°
æ­¤æ¨¡çµ„å®Œæˆå¾Œï¼Œæ¥çºŒæ‡‰é–‹ç™¼ï¼š
ğŸ“˜ è‡ªæˆ‘åæ€æ¨¡çµ„ï¼ˆReflection Moduleï¼‰å·¥ç¨‹èªè¨€æŒ‡å—æ›¸
 â†’ ç”±è¨˜æ†¶æ¨¡çµ„è§¸ç™¼èˆ‡å›å¯«çš„åæ€é‚è¼¯


ğŸ“— å¾®èª¿æ¨¡çµ„ï¼ˆFineTune Moduleï¼‰æŒ‡å—æ›¸
 â†’ å®šæœŸå¾è¨˜æ†¶æ¨¡çµ„æ“·å–åæ€è³‡æ–™è¨“ç·´ QLoRA




