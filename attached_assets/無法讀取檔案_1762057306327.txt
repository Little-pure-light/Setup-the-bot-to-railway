PromptEngine æª”æ¡ˆæ³¨å…¥ä¿®å¾©å·¥ç¨‹æŒ‡ä»¤æ›¸ï¼ˆFor Agent AI é–‹ç™¼ï¼‰
ğŸ¯ ä¿®æ­£ç›®æ¨™

è§£æ±º PromptEngine ç„¡æ³•å¼•ç”¨ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆå…§å®¹çš„å•é¡Œï¼Œç¢ºä¿ AI å›æ‡‰èƒ½æ­£ç¢ºåŒ…å«æª”æ¡ˆä¸Šä¸‹æ–‡ã€‚

ğŸ§© å•é¡Œæè¿°èˆ‡æ ¹å› 
å•é¡Œç¾è±¡ï¼š

ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆæˆåŠŸï¼ˆRedis æœ‰å„²å­˜ file_name, summary, contentï¼‰ã€‚

å‰ç«¯é¡¯ç¤ºæˆåŠŸï¼Œä½† AI å›è¦†ç„¡åƒè€ƒæª”æ¡ˆå…§å®¹ã€‚

ç„¡ API error logï¼Œä½† prompt ç„¡æª”æ¡ˆä¸Šä¸‹æ–‡ï¼Œå°è‡´ AI ç„¡æ³•æ„ŸçŸ¥ä½¿ç”¨è€…èƒŒæ™¯è³‡æ–™ã€‚

æ ¹æœ¬åŸå› ï¼š

chat_router.py æ²’æœ‰å¾ Redis è®€å–æª”æ¡ˆå…§å®¹ï¼Œä¹Ÿæœªå‚³çµ¦ PromptEngine.build_prompt()ã€‚

prompt_engine.py çš„ build_prompt() æœªè¨­è¨ˆè™•ç† file_contentï¼Œå°è‡´å…§å®¹æœªé€²å…¥ system promptã€‚

è‹¥ memories_table è¨­å®šéŒ¯èª¤ï¼ˆSupabaseï¼‰ï¼Œä¹Ÿå¯èƒ½é€ æˆ PromptEngine åˆå§‹åŒ–éŒ¯èª¤ã€‚

ğŸ”§ ä¿®æ­£é …ç›®æ˜ç´°
â‘  ä¿®æ”¹ chat_router.py â€“ åŠ å…¥ Redis æª”æ¡ˆè®€å–èˆ‡å‚³éé‚è¼¯

æ–°å¢ç¨‹å¼ç¢¼ï¼š

try:
    redis_keys = redis_interface.client.keys(f"file:*:{conversation_id}")
    if redis_keys:
        latest_key = redis_keys[-1]
        file_data = redis_interface.client.get(latest_key)
        file_content = json.loads(file_data).get("content", "")
    else:
        file_content = ""
except Exception as e:
    logger.error(f"[File Load Error] {e}")
    file_content = ""


ä¸¦å°‡ file_content å‚³å…¥ build_promptï¼š

messages = await prompt_engine.build_prompt(
    user_message=user_message,
    recalled_memories=recalled_memories,
    file_content=file_content
)

â‘¡ ä¿®æ”¹ prompt_engine.py â€“ æ”¯æ´æ³¨å…¥ file_content

ä¿®æ”¹ build_prompt() å‡½å¼ç°½åèˆ‡é‚è¼¯ï¼š

async def build_prompt(
    self,
    user_message: str,
    recalled_memories: str = "",
    file_content: str = ""
):
    ...
    system_prompt = BASE_PROMPT

    if file_content:
        system_prompt += f"\n\n### ç›¸é—œæª”æ¡ˆå…§å®¹\n{file_content[:1500]}"

âœ… é©—æ”¶èˆ‡æ¸¬è©¦é …ç›®
æ¸¬è©¦é …ç›®	é©—è­‰æ–¹å¼	é æœŸçµæœ
Redis æª”æ¡ˆç¢ºèª	redis-cli æŸ¥è©¢ file:* éµå€¼	æœ‰å°æ‡‰ file:<conversation_id> éµ
Prompt æª¢æŸ¥	åŸ·è¡Œ test_chat.py	çµ‚ç«¯è¼¸å‡ºå«ã€Œ### ç›¸é—œæª”æ¡ˆå…§å®¹ã€
æ¨¡å‹è¡Œç‚ºæ¸¬è©¦	èŠå¤©ä¸­è¼¸å…¥ã€Œå¹«æˆ‘æ‘˜è¦ä¸Šå‚³çš„æª”æ¡ˆã€	å›æ‡‰èƒ½å¼•ç”¨æª”æ¡ˆæ‘˜è¦
éŒ¯èª¤å®¹éŒ¯	æ¨¡æ“¬ç„¡ Redis æª”æ¡ˆæƒ…å¢ƒ	ç³»çµ±ä¸å´©æ½°ï¼ŒAI ä»èƒ½æ­£å¸¸é‹ä½œï¼ˆfile_content = ""ï¼‰
âš ï¸ æ³¨æ„äº‹é …èˆ‡é¢¨éšªæ§ç®¡
é …ç›®	èªªæ˜
Prompt Token é™åˆ¶	å»ºè­°åªæ³¨å…¥å‰ 1500â€“2000 å­—ï¼Œé¿å…è¶…éæ¨¡å‹ token é™åˆ¶ã€‚
å¤šæª”æ¡ˆè™•ç†	ç›®å‰åƒ…æ”¯æ´å–æœ€å¾Œä¸€ç­†ä¸Šå‚³è¨˜éŒ„ï¼Œå¦‚éœ€å¤šæª”ç®¡ç†éœ€å¦é–‹å¯¦ä½œã€‚
Supabase è¨˜æ†¶è¡¨	è‹¥æŒ‡å®šçš„ memories_table åç¨±éŒ¯èª¤ï¼ŒPromptEngine åˆå§‹åŒ–æœƒå¤±æ•—ã€‚è«‹ç¢ºèªåç¨±è¨­å®šæ­£ç¢ºï¼Œå¦‚ç„¡è¡¨å‰‡è¨­å®šç‚º "memory_statistics" æˆ–ç•™ç©ºã€‚