è¨˜æ†¶-åæ€æ¨¡çµ„ï¼ˆMemory Moduleï¼‰å·¥ç¨‹èªè¨€è¨­è¨ˆæŒ‡å—æ›¸
ç”¨é€”ï¼šçµ¦ Agent AI ç›´æ¥åŸ·è¡Œã€‚
 ç›®æ¨™ï¼šåœ¨ç¾æœ‰å°ˆæ¡ˆå…§æ–°å¢ã€Œæ•¸å­—åŒ–è¨˜æ†¶å±¤ã€ï¼Œä»¥ Token ç‚ºæ ¸å¿ƒå„²å­˜å°è©±/åæ€ï¼ŒRedis ä½œæš«å­˜ã€Supabase ä½œé•·å­˜ã€‚
 é‡è¦ï¼šä¸å¾—æ”¹å‹•ç¾æœ‰å¯é‹ä½œ API èˆ‡è³‡æ–™è¡¨ï¼›æ¬„ä½å‘½åè¦å‰å¾Œä¸€è‡´ï¼›å¯æ’æ‹”æ¨¡çµ„ã€‚

0) å°ˆæ¡ˆå‰æï¼ˆè«‹åš´æ ¼éµå®ˆï¼‰
å¾Œç«¯ï¼šFastAPIï¼ˆbackend/ï¼‰ï¼Œå·²å­˜åœ¨ chat_router.py / memory_router.py / prompt_engine.py / supabase_handler.pyã€‚


ä¸å¾—ç§»é™¤æˆ–é‡å‘½åç¾æœ‰æª”æ¡ˆèˆ‡ APIï¼›åªèƒ½æ–°å¢æ¨¡çµ„èˆ‡è¼•åº¦æ›è¼‰ã€‚


ç›®å‰å·²æœ‰ 6 å€‹è³‡æ–™è¡¨ï¼›è«‹å‹¿æ–°å¢è³‡æ–™è¡¨ï¼Œåƒ…ä»¥å¯è¨­å®šçš„å°æ‡‰å¯«å…¥æ—¢æœ‰è¡¨æ¬„ä½ã€‚


æ‰€æœ‰å„²å­˜å…§å®¹ä»¥Token æ•¸å­—åŒ–ç‚ºä¸»ï¼›æ–‡å­—å¯é¸æ“‡æ€§ä¿ç•™æ–¼ text_cache é¡æ¬„ä½ï¼ˆè‹¥å°ˆæ¡ˆå·²æœ‰ï¼‰ã€‚


æ¨¡çµ„éœ€å¯ç¨ç«‹å•Ÿç”¨/åœç”¨ï¼Œä¸¦å…·å‚™å¥åº·æª¢æŸ¥ã€‚



1) äº¤ä»˜å…§å®¹ï¼ˆéœ€ç”¢ç”Ÿçš„æª”æ¡ˆèˆ‡ä½ç½®ï¼‰
backend/
â”œâ”€ modules/
â”‚  â””â”€ memory/
â”‚     â”œâ”€ __init__.py
â”‚     â”œâ”€ core.py                 # è¨˜æ†¶æ ¸å¿ƒï¼šRedisæš«å­˜ã€TokenåŒ–ã€Supabaseé•·å­˜
â”‚     â”œâ”€ io_contract.py          # I/O è³‡æ–™å”å®šï¼ˆæ¬„ä½å‘½åèˆ‡çµæ§‹æ ¡é©—ï¼‰
â”‚     â”œâ”€ tokenizer.py            # tiktoken å°è£èˆ‡é™ç´šæ–¹æ¡ˆ
â”‚     â”œâ”€ config.json             # æ¨¡çµ„é–‹é—œèˆ‡è¡¨æ¬„ä½æ˜ å°„
â”‚     â””â”€ README.md               # ä½¿ç”¨èªªæ˜ï¼ˆå¦‚ä½•æ›è¼‰ã€æ¸¬è©¦ï¼‰
â”œâ”€ jobs/
â”‚  â””â”€ memory_flush_worker.py     # å¾Œå°æ’ç¨‹ï¼šå°‡ Redis æ‰¹é‡åˆ·å¯«åˆ° Supabase
â””â”€ core_controller.py            # è‹¥ä¸å­˜åœ¨ï¼Œæ²¿ç”¨æ—¢æœ‰ï¼›å¦å‰‡åœ¨æ­¤è¨»å†Šå•Ÿç”¨ memory æ¨¡çµ„

ä¸å¾—ç§»é™¤æˆ–é‡å¯«ç¾æœ‰ routerï¼›åƒ…åœ¨ core_controller.pyï¼ˆæˆ– main.py å•Ÿå‹•æ®µï¼‰æ›è¼‰ memory æ¨¡çµ„å³å¯ã€‚

2) ç’°å¢ƒè®Šæ•¸ï¼ˆæ–°å¢ä½†ä¸å½±éŸ¿æ—¢æœ‰ï¼‰
REDIS_URL=redis://:password@host:6379/0
MEMORY_REDIS_TTL_SECONDS=172800          # 2å¤©
MEMORY_FLUSH_BATCH_SIZE=100              # æ¯æ¬¡åˆ·å¯«æœ€å¤§ç­†æ•¸
MEMORY_TABLE_MAP='{"conversations":"conversations","memories":"memories"}'
TOKENIZER_NAME=cl100k_base               # tiktoken å­—å…¸åï¼›ç„¡å‰‡èµ°é™ç´šæ–¹æ¡ˆ

MEMORY_TABLE_MAP ä»¥ JSON è¨­å®šæŠŠã€Œæ¨¡çµ„é‚è¼¯è¡¨åã€â¡ã€Œç¾æœ‰å¯¦éš›è¡¨åã€ã€‚è«‹å‹¿ç¡¬ç·¨ç¢¼è¡¨åï¼Œé¿å…å’Œæ—¢æœ‰ 6 è¡¨è¡çªã€‚

3) æ¬„ä½å‘½åè¦ç¯„ï¼ˆå¿…é ˆéµå®ˆï¼Œä¸€è‡´æ€§æœ€é«˜å„ªå…ˆï¼‰
ä»¥ä¸‹æ¬„ä½åœ¨é•·æœŸå„²å­˜ï¼ˆSupabaseï¼‰æ™‚å¿…é ˆå­˜åœ¨ï¼ˆè‹¥è¡¨çµæ§‹å·²ä¸åŒï¼Œè«‹åœ¨ config.json åšæ¬„ä½æ˜ å°„ï¼‰ï¼š
è¦ç¯„æ¬„ä½
èªªæ˜
è³‡æ–™å‹æ…‹ï¼ˆå»ºè­°ï¼‰
conversation_id
å°è©± ID
text
user_id
ä½¿ç”¨è€… ID
text
user_message
ä½¿ç”¨è€…è¼¸å…¥åŸæ–‡
textï¼ˆå¯ç©ºï¼›ä»¥ token ç‚ºä¸»ï¼‰
assistant_message
AI å›è¦†åŸæ–‡
textï¼ˆå¯ç©ºï¼›ä»¥ token ç‚ºä¸»ï¼‰
reflection
åæ€æ‘˜è¦ï¼ˆJSON å£“æˆ text æˆ– jsonbï¼‰
text/json
token_data
Token åŒ–çµæœï¼ˆå« user/assistant/reflectionï¼‰
json
cid
IPFS ç´¢å¼•ï¼ˆé¸ç”¨ï¼‰
text
created_at
å»ºç«‹æ™‚é–“
timestamptz

å‰å¾Œç«¯ä¸€å¾‹ä½¿ç”¨é€™çµ„éµåï¼›è‹¥è³‡æ–™è¡¨æ—¢æœ‰éµåä¸åŒï¼Œç”¨ config.json åšæ˜ å°„ï¼ˆä¾‹å¦‚ assistant_mes â†” assistant_messageï¼‰ã€‚

4) I/O åˆç´„ï¼ˆio_contract.pyï¼‰
å¯¦ä½œ validate_and_normalize(payload: dict) -> dict


å°‡å‰ç«¯/è·¯ç”±å‚³å…¥çš„è³‡æ–™æ ¡é©—å¾Œï¼Œè¼¸å‡ºçµ±ä¸€çµæ§‹ï¼š


{
  "conversation_id": str,
  "user_id": str,
  "user_message": str|None,
  "assistant_message": str|None,
  "reflection": {"summary": str, "causes": [str, ...]} | None,
  "token_data": {"user": [int,...], "assistant": [int,...], "reflection": [int,...]},
  "cid": str|None,
  "created_at": iso8601
}

åš´æ ¼ï¼šç¼ºå°‘ conversation_id / user_id è¦–ç‚ºç„¡æ•ˆï¼›å…¶é¤˜å¯ç‚º Noneã€‚



5) Tokenizerï¼ˆtokenizer.pyï¼‰
é è¨­ä½¿ç”¨ tiktokenï¼ˆTOKENIZER_NAMEï¼‰ï¼Œä¸å¯ç›´ä¾è³´ OpenAI APIã€‚


è‹¥ç’°å¢ƒç„¡ tiktokenï¼Œæä¾›é™ç´šæ–¹æ¡ˆï¼š


ä»¥ UTF-8 bytes æˆ– ç°¡å–® BPE æ›¿ä»£å°‡å­—ä¸²è½‰ç‚ºæ•´æ•¸åºåˆ—ï¼ˆä¿åºå³å¯ï¼‰ã€‚


æä¾›æ–¹æ³•ï¼š


def tokenize_text(text: str) -> list[int]
def pack_token_record(user: str|None, assistant: str|None, reflection_json: dict|None) -> dict


6) è¨˜æ†¶æ ¸å¿ƒï¼ˆcore.pyï¼‰
è·è²¬ï¼š
Redis çŸ­æœŸè¨˜æ†¶ï¼šå¯«å…¥æœ€è¿‘ä¸€ç­†å°è©±ï¼ˆå«åæ€ï¼‰ï¼ŒKey è¦æ ¼èˆ‡ TTLã€‚


Supabase é•·æœŸè¨˜æ†¶ï¼šå°‡ Token åŒ–çµæœèˆ‡æ¬„ä½æ˜ å°„å¾Œå¯«å…¥å°æ‡‰è³‡æ–™è¡¨ã€‚


æ‰¹æ¬¡åˆ·å¯«ï¼šç”± worker å®šæ™‚å¾ Redis æ‰¹æ¬¡å–å‡ºã€åˆä½µã€Upsert åˆ° Supabaseã€‚


6.1 Redis key èˆ‡è³‡æ–™çµæ§‹
keyï¼šconv:{conversation_id}:latest


valueï¼šJSON


{
  "user_msg": "...",
  "assistant_msg": "...",
  "reflection": {"summary":"...", "causes":["..."]},
  "token_data": {"user":[...], "assistant":[...], "reflection":[...]},
  "user_id": "user_xxx",
  "ts": 1739900000
}

6.2 Public APIï¼ˆçµ¦ chat_router / prompt_engine ä½¿ç”¨ï¼‰
def store_short_term(conversation_id: str, user_id: str, user_msg: str|None, assistant_msg: str|None, reflection: dict|None) -> None
def load_recent_context(conversation_id: str) -> dict|None
def persist_long_term(records: list[dict]) -> int  # å¯«å…¥ Supabaseï¼Œå›å‚³ç­†æ•¸
def store_conversation(conversation_id, user_id, user_msg, assistant_msg, reflection) -> None

store_conversation() å…§éƒ¨å‘¼å« tokenize_text â†’ store_short_termï¼›ä¸¦å°‡åŒçµ„è³‡æ–™ä¸Ÿå…¥ Redis listï¼ˆç­‰ worker æ‰¹æ¬¡åˆ·å¯«ï¼‰ã€‚


6.3 Supabase å¯«å…¥ï¼ˆç¶“æ˜ å°„ï¼‰
è®€å– config.json æ¬„ä½æ˜ å°„ï¼ˆä¾‹å¦‚ assistant_message â†” assistant_mesï¼‰ã€‚


å–®ç­† upsertï¼ˆå”¯ä¸€éµå»ºè­° conversation_id + created_atï¼‰ï¼›æˆ–ç”± worker æ‰¹æ¬¡ upsertã€‚



7) æ¨¡çµ„è¨­å®šï¼ˆmodules/memory/config.jsonï¼‰
{
  "name": "memory",
  "enabled": true,
  "version": "1.0.0",
  "tables": {
    "conversations": "conversations",
    "memories": "memories"
  },
  "columns_map": {
    "conversation_id": "conversation_id",
    "user_id": "user_id",
    "user_message": "user_message",
    "assistant_message": "assistant_message",
    "reflection": "reflection",
    "token_data": "token_data",
    "cid": "cid",
    "created_at": "created_at"
  }
}

è‹¥ç¾æœ‰è¡¨æ¬„ä½ä¸åŒï¼Œä¿®æ”¹ columns_map å³å¯ï¼ˆä¾‹å¦‚æŠŠ assistant_message æ˜ åˆ°æ—¢æœ‰çš„ assistant_mesï¼‰ã€‚

8) å¾Œå°æ‰¹æ¬¡åˆ·å¯«ï¼ˆjobs/memory_flush_worker.pyï¼‰
å¾ Redis å– pending:listï¼ˆæˆ–ä»¥ stream/éšŠåˆ—ï¼‰ï¼Œæ¯æ¬¡å½™æ•´ MEMORY_FLUSH_BATCH_SIZE ç­†ï¼Œå‘¼å« persist_long_term()ã€‚


å¤±æ•—é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼Œé€€é¿ 1/2/4sï¼‰ï¼Œé¿å…æ‰è³‡æ–™ã€‚


å¯ç”¨ç°¡å–® apscheduler æˆ–æ‰‹å‹•å‘¼å«ï¼›ä¸å¾—é˜»å¡ä¸» API åŸ·è¡Œç·’ã€‚



9) è·¯ç”±æ¥é»ï¼ˆæœ€å°æ”¹å‹•ï¼‰
ä¸æ”¹æ—¢æœ‰ APIï¼›åƒ…åœ¨ chat_router.py å®Œæˆå›è¦†å¾Œï¼Œè£œä¸€è¡Œå‘¼å«ï¼š
# chat_router.py å…§ï¼Œç”Ÿæˆ assistant_message èˆ‡ reflection å¾Œï¼š
from backend.modules.memory.core import store_conversation

store_conversation(
    conversation_id=request.conversation_id,
    user_id=request.user_id,
    user_msg=user_message,
    assistant_msg=assistant_message,
    reflection=reflection_obj  # dict or None
)

è‹¥æª”æ¡ˆè·¯å¾‘ä¸åŒï¼Œä»¥å¯¦éš›å°ˆæ¡ˆç‚ºæº–ï¼›ä¸å¯ç ´å£ç¾æœ‰å›å‚³æ ¼å¼ã€‚

ğŸ” æ¸¬è©¦èˆ‡é©—æ”¶ï¼ˆAgent å¿…é ˆæä¾›ï¼‰
å–®å…ƒæ¸¬è©¦ï¼š


tokenizer.tokenize_text() å°ä¸­æ–‡/è‹±æ–‡/è¡¨æƒ…ç¬¦è™Ÿä¸å ±éŒ¯ï¼›


store_short_term() å¯«å…¥å¾Œèƒ½ load_recent_context() å–å›ï¼›


persist_long_term() èƒ½ä¾ columns_map æˆåŠŸ upsertã€‚


æ‰‹å‹•æµç¨‹ï¼š


ç”¨ /api/chat ç™¼é€ä¸€å‰‡è¨Šæ¯ï¼›


é©—è­‰ Redis æœ‰ conv:{conversation_id}:latestï¼›


è§¸ç™¼ worker åˆ·å¯«å¾Œï¼ŒSupabase æœ‰æ–°å¢ä¸€ç­†ï¼ˆå« token_dataã€reflectionï¼‰ã€‚


ä¸ç ´å£æ€§ï¼š


ä¸æ–°å¢è³‡æ–™è¡¨ï¼›


ä¸ä¿®æ”¹æ—¢æœ‰ API è·¯ç”±ï¼›


æ¬„ä½åç¨±èˆ‡å‰ç«¯ä½¿ç”¨ä¸€è‡´ã€‚



ğŸ“„ READMEï¼ˆmodules/memory/README.md å¿…å¯«ï¼‰
æ¨¡çµ„ç”¨é€”ï¼ˆçŸ­æœŸè¨˜æ†¶ã€é•·æœŸè¨˜æ†¶ã€Token åŒ–ï¼‰


éœ€è¦çš„ç’°å¢ƒè®Šæ•¸


æ¬„ä½æ˜ å°„æ–¹å¼ï¼ˆå¦‚ä½•æ”¹ columns_map é©é…ç¾æœ‰ 6 è¡¨ï¼‰


æœ¬åœ°æ¸¬è©¦æ­¥é©Ÿï¼ˆRedis + Supabaseï¼‰


å¸¸è¦‹éŒ¯èª¤èˆ‡æ’é™¤



ğŸ›¡ï¸ é˜²å‘†è¦ç¯„ï¼ˆå¿…éµå®ˆï¼‰
åš´ç¦åœ¨æ¨¡çµ„å…§ç›´æ¥å¯«æ­»è¡¨åèˆ‡æ¬„ä½åï¼›ä¸€å¾‹ç”± config.json æˆ–ç’°å¢ƒè®Šæ•¸æä¾›ã€‚


åš´ç¦åœ¨æ¨¡çµ„å…§ç™¼ API æ ¼å¼è®Šæ›´ï¼›ç¾æœ‰å‰ç«¯ä¸å¯æ„ŸçŸ¥æœ¬æ¨¡çµ„å­˜åœ¨èˆ‡å¦ã€‚


åš´ç¦å°‡å¤§é‡æ–‡å­—ç›´æ¥é•·å­˜ï¼›ä»¥ token_data ç‚ºä¸»ï¼Œæ–‡å­—åƒ…å¯é¸æ“‡æ€§æ”¾ text_cache é¡æ¬„ä½ã€‚


å…è¨±æ¨¡çµ„åœç”¨ï¼šconfig.json è¨­ enabled=falseï¼Œç³»çµ±ä»å¯é‹ä½œã€‚



âœ… æœ€çµ‚ç”¢å‡ºï¼ˆAgent å¿…é ˆå›è¦†ï¼‰
æ–°å¢æª”æ¡ˆçš„å®Œæ•´æ¨¹ç‹€çµæ§‹


core.py / tokenizer.py / io_contract.py / memory_flush_worker.py çš„å®Œæ•´ç¨‹å¼ç¢¼


config.json èˆ‡ README ç¯„ä¾‹


åœ¨ chat_router.py çš„å–®é»æ›è¼‰ç¨‹å¼ç¢¼ç‰‡æ®µï¼ˆä¸æ”¹å›å‚³ï¼‰


ä¸€ä»½ã€Œé©—æ”¶æ­¥é©Ÿã€æ¸…å–®ï¼ˆå« Redis â†’ Supabase é©—è­‰ï¼‰


